This notebook inputs per-plate profiles as generated by the [pooled-cell-painting-profiling-recipe](https://github.com/broadinstitute/pooled-cell-painting-profiling-recipe) and further aggregates them into the per-experiment guide-level profiles that have undergone feature selection.
The guide-level profiles used in this paper for generating hit lists (see [Hit_Calling](../Hit_Calling/)).
The guide-level profiles are further aggregatd into gene-level profiles used for generating figures in this paper.

This notebook requires several hours of computation time for a normal desktop computer on a genome-scale dataset.

To run the notebooks you will need to download the following files to the `inputs_data` folder.
`20210422_6W_CP257_guide_normalized_ALLBATCHES___{plate}___ALLWELLS.csv.gz` for all HeLa plates ['CP257A','CP257B','CP257D','CP257F','CP257H','CP257J','CP257K','CP257L','CP257N'].
`20210422_6W_CP257_guide_normalized_ALLBATCHES___{plate}___ALLWELLS.csv.gz` for all A549 plates ['CP186','CP186B','CP186C','CP186D','CP186E','CP186F','CP186G','CP186H','CP186N'].

The following command will download these files:
```bash
aws s3 cp --recursive --no-sign-request s3://cellpainting-gallery/cpg0021-periscope/broad/workspace/profiles/ inputs --exclude "*" --include "20210422_6W_CP257_guide_normalized_ALLBATCHES___*" --include "20200805_A549_WG_Screen_guide_normalized_ALLBATCHES___*"
```

These are the guide-level profiles generated by `Plate level aggregation` in the first part of this notebook:
`20200805_A549_WG_Screen_guide_normalized_feature_select_median_merged_ALLBATCHES___CP186___ALLWELLS.csv.gz`  
`20210422_6W_CP257_guide_normalized_feature_select_median_merged_ALLBATCHES___DMEM___ALLWELLS.csv.gz`  
`20210422_6W_CP257_guide_normalized_feature_select_median_merged_ALLBATCHES___HPLM___ALLWELLS.csv.gz` 

These are the gene-level profiles generate by `Gene level aggregation` in the second part of this notebook:
`20200805_A549_WG_Screen_guide_normalized_feature_select_median_merged_ALLBATCHES___CP186___ALLWELLS_gene_aggregated.csv.gz`  
`20210422_6W_CP257_guide_normalized_feature_select_median_merged_ALLBATCHES___DMEM___ALLWELLS_gene_aggregated.csv.gz`  
`20210422_6W_CP257_guide_normalized_feature_select_median_merged_ALLBATCHES___HPLM___ALLWELLS_gene_aggregated.csv.gz` 

To skip running all aggregation locally, you can directly download the output files using the following command:
```bash
aws s3 cp --recursive --no-sign-request s3://cellpainting-gallery/cpg0021-periscope/broad/workspace/profiles/ outputs --exclude "*" --include "20210422_6W_CP257_guide_normalized_feature_select_median_merged_ALLBATCHES___*" --include "20200805_A549_WG_Screen_guide_normalized_feature_select_median_merged_ALLBATCHES___*"
```